<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/layout :: layout(~{::content})}">
<body>
<div th:fragment="content">
    <div class="breadcrumb">
        <a href="/admin">대시보드</a> &gt;
        <a href="/admin/projects">프로젝트</a> &gt;
        <span th:text="${project.name}">Project Name</span>
    </div>

    <h1><span th:text="${project.name}">Project Name</span> <span style="color: #7f8c8d; font-size: 0.5em;">(ID: <span th:text="${project.id}">1</span>)</span></h1>
    <p th:if="${project.description}" th:text="${project.description}" style="color: #7f8c8d; margin-bottom: 10px;">Description</p>
    <p style="color: #7f8c8d; margin-bottom: 20px;">
        초기 대기자 수:
        <span id="waitingOffsetDisplay" th:text="${project.waitingOffset}">0</span>명
        <button onclick="showEditWaitingOffset()" class="btn btn-secondary" style="margin-left: 10px; padding: 4px 10px; font-size: 12px;">수정</button>
        <span id="waitingOffsetEdit" style="display: none;">
            <input type="number" id="waitingOffsetInput" th:value="${project.waitingOffset}" min="0" style="width: 100px; padding: 4px 8px;">
            <button onclick="updateWaitingOffset()" class="btn" style="padding: 4px 10px; font-size: 12px;">저장</button>
            <button onclick="hideEditWaitingOffset()" class="btn btn-secondary" style="padding: 4px 10px; font-size: 12px;">취소</button>
        </span>
    </p>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" th:text="${stats.totalPageViews}">0</div>
            <div class="stat-label">페이지뷰</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" th:text="${stats.totalUniqueVisitors}">0</div>
            <div class="stat-label">순 방문자</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" th:text="${stats.totalEmails}">0</div>
            <div class="stat-label">수집된 이메일</div>
        </div>
        <div class="stat-card">
            <div class="stat-value conversion-rate" th:text="${#numbers.formatDecimal(stats.conversionRate, 1, 1) + '%'}">0%</div>
            <div class="stat-label">전환율</div>
        </div>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin-bottom: 0;">채널별 통계</h2>
            <a th:href="@{/admin/projects/{id}/emails(id=${project.id})}" class="btn">이메일 보기</a>
        </div>

        <div th:if="${#lists.isEmpty(stats.channelStats)}" class="empty-state">
            <p>아직 트래픽 데이터가 없습니다. API를 사용하여 추적을 시작하세요.</p>
        </div>

        <table th:if="${!#lists.isEmpty(stats.channelStats)}">
            <thead>
                <tr>
                    <th>채널</th>
                    <th>페이지뷰</th>
                    <th>순 방문자</th>
                    <th>이메일</th>
                    <th>전환율</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="channel : ${stats.channelStats}">
                    <td th:text="${channel.channel}">channel</td>
                    <td th:text="${channel.pageViews}">0</td>
                    <td th:text="${channel.uniqueVisitors}">0</td>
                    <td th:text="${channel.emails}">0</td>
                    <td class="conversion-rate" th:text="${#numbers.formatDecimal(channel.conversionRate, 1, 1) + '%'}">0%</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin-bottom: 0;">일별 통계</h2>
            <div>
                <a th:href="@{/admin/projects/{id}(id=${project.id}, days=7)}"
                   th:classappend="${days == 7} ? 'btn' : 'btn btn-secondary'" style="margin-right: 5px;">7일</a>
                <a th:href="@{/admin/projects/{id}(id=${project.id}, days=30)}"
                   th:classappend="${days == 30} ? 'btn' : 'btn btn-secondary'" style="margin-right: 5px;">30일</a>
                <a th:href="@{/admin/projects/{id}(id=${project.id}, days=90)}"
                   th:classappend="${days == 90} ? 'btn' : 'btn btn-secondary'">90일</a>
            </div>
        </div>

        <div th:if="${#lists.isEmpty(dailyStats)}" class="empty-state">
            <p>아직 일별 데이터가 없습니다.</p>
        </div>

        <table th:if="${!#lists.isEmpty(dailyStats)}">
            <thead>
                <tr>
                    <th>날짜</th>
                    <th>페이지뷰</th>
                    <th>순 방문자</th>
                    <th>이메일</th>
                    <th>전환율</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="daily : ${dailyStats}">
                    <td th:text="${daily.date}">2024-01-01</td>
                    <td th:text="${daily.pageViews}">0</td>
                    <td th:text="${daily.uniqueVisitors}">0</td>
                    <td th:text="${daily.emails}">0</td>
                    <td class="conversion-rate" th:text="${#numbers.formatDecimal(daily.conversionRate, 1, 1) + '%'}">0%</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <h2>게시물별 통계</h2>

        <div th:if="${#lists.isEmpty(postStats)}" class="empty-state">
            <p>아직 게시물별 데이터가 없습니다. 추적 시 postNumber 파라미터를 사용하세요.</p>
        </div>

        <table th:if="${!#lists.isEmpty(postStats)}">
            <thead>
                <tr>
                    <th>채널</th>
                    <th>게시물 번호</th>
                    <th>페이지뷰</th>
                    <th>순 방문자</th>
                    <th>이메일</th>
                    <th>전환율</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="post : ${postStats}">
                    <td th:text="${post.channel}">channel</td>
                    <td th:text="${post.postNumber}">123</td>
                    <td th:text="${post.pageViews}">0</td>
                    <td th:text="${post.uniqueVisitors}">0</td>
                    <td th:text="${post.emails}">0</td>
                    <td class="conversion-rate" th:text="${#numbers.formatDecimal(post.conversionRate, 1, 1) + '%'}">0%</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <h2>연동 가이드</h2>
        <p style="margin-bottom: 15px;">랜딩페이지에 아래 추적 코드를 추가하세요:</p>

        <div style="background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 13px; overflow-x: auto;">
            <pre style="margin: 0; white-space: pre-wrap;">// Get or create visitor ID (store in cookie)
function getVisitorId() {
    let id = document.cookie.match(/visitorId=([^;]+)/)?.[1];
    if (!id) {
        id = crypto.randomUUID();
        document.cookie = `visitorId=${id}; max-age=31536000; path=/`;
    }
    return id;
}

// Track page view on load
const visitorId = getVisitorId();
fetch(`${window.location.origin}/api/track?projectId=<span th:text="${project.id}">1</span>&amp;channel=YOUR_CHANNEL&amp;postNumber=YOUR_POST_NUMBER&amp;visitorId=${visitorId}`);

// Submit email
async function submitEmail(email) {
    await fetch(`${window.location.origin}/api/email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            projectId: <span th:text="${project.id}">1</span>,
            email: email,
            channel: 'YOUR_CHANNEL',
            postNumber: 'YOUR_POST_NUMBER'
        })
    });
}

// Get real-time waiting count (waitingOffset + email subscribers)
fetch(`${window.location.origin}/api/projects/<span th:text="${project.id}">1</span>/waiting-count`)
    .then(res => res.json())
    .then(data => {
        console.log('현재 대기자 수:', data.waitingCount);
    });</pre>
        </div>
    </div>

    <script th:inline="javascript">
        const projectId = [[${project.id}]];

        function showEditWaitingOffset() {
            document.getElementById('waitingOffsetDisplay').style.display = 'none';
            document.getElementById('waitingOffsetEdit').style.display = 'inline';
            document.getElementById('waitingOffsetInput').focus();
        }

        function hideEditWaitingOffset() {
            document.getElementById('waitingOffsetDisplay').style.display = 'inline';
            document.getElementById('waitingOffsetEdit').style.display = 'none';
        }

        async function updateWaitingOffset() {
            const waitingOffset = parseInt(document.getElementById('waitingOffsetInput').value) || 0;

            try {
                const response = await fetch(`/api/admin/projects/${projectId}/waiting-offset`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ waitingOffset: waitingOffset })
                });

                if (response.ok) {
                    document.getElementById('waitingOffsetDisplay').textContent = waitingOffset;
                    hideEditWaitingOffset();
                } else {
                    alert('수정에 실패했습니다.');
                }
            } catch (error) {
                alert('오류가 발생했습니다: ' + error.message);
            }
        }
    </script>
</div>
</body>
</html>
